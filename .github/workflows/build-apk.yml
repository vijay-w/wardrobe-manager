name: 构建Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: 设置Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 缓存Gradle依赖
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: 修复并设置Gradle包装器
      run: |
        echo "检查gradlew文件状态..."
        ls -la gradlew || echo "gradlew文件不存在"
        
        # 检查文件格式和内容
        if [ -f "./gradlew" ]; then
          echo "检查文件格式..."
          file gradlew
          head -1 gradlew
          
          # 尝试修复文件格式（转换Windows换行符）
          echo "修复文件格式..."
          dos2unix gradlew 2>/dev/null || sed -i 's/\r$//' gradlew
          chmod +x gradlew
          
          # 测试是否可执行
          if ! ./gradlew --version 2>/dev/null; then
            echo "gradlew文件损坏，重新生成..."
            rm -f gradlew
          fi
        fi
        
        # 如果文件不存在或损坏，重新生成
        if [ ! -f "./gradlew" ]; then
          echo "重新生成Gradle包装器，强制使用版本8.4"
          
          # 确保gradle/wrapper目录存在
          mkdir -p gradle/wrapper
          
          # 强制设置正确的Gradle版本配置
          echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
          echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
          echo "distributionUrl=https\\://services.gradle.org/distributions/gradle-8.4-bin.zip" >> gradle/wrapper/gradle-wrapper.properties
          echo "networkTimeout=10000" >> gradle/wrapper/gradle-wrapper.properties
          echo "validateDistributionUrl=true" >> gradle/wrapper/gradle-wrapper.properties
          echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
          echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
          
          echo "配置文件已更新为Gradle 8.4"
          cat gradle/wrapper/gradle-wrapper.properties
          
          # 下载并创建gradlew脚本（使用curl直接下载）
          echo "下载Gradle 8.4包装器脚本..."
          curl -s https://raw.githubusercontent.com/gradle/gradle/v8.4.0/gradlew -o gradlew
          chmod +x gradlew
          
          # 验证下载的gradlew
          if [ ! -f "./gradlew" ] || [ ! -x "./gradlew" ]; then
            echo "下载失败，使用系统gradle生成..."
            gradle wrapper --gradle-version 8.4 --distribution-type bin
            chmod +x gradlew
          fi
        fi
        
    - name: 验证Gradle设置
      run: |
        echo "最终验证..."
        ls -la gradlew
        file gradlew
        echo "测试Gradle版本..."
        ./gradlew --version
      
    - name: 运行测试
      run: ./gradlew test --stacktrace
      
    - name: 构建Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: 构建Release APK
      run: ./gradlew assembleRelease --stacktrace
      
    - name: 上传Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: wardrobe-manager-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        
    - name: 上传Release APK
      uses: actions/upload-artifact@v4
      with:
        name: wardrobe-manager-release
        path: app/build/outputs/apk/release/app-release-unsigned.apk
        
    - name: 创建Release（如果是tag推送）
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/release/app-release-unsigned.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}